package model

import (
	"time"

	"github.com/m-mizutani/octovy/pkg/domain/model/trivy"
	"github.com/m-mizutani/octovy/pkg/domain/types"
)

// CVSS represents CVSS information
type CVSS struct {
	V2Vector string
	V3Vector string
	V2Score  float64
	V3Score  float64
}

// Vulnerability represents a detected vulnerability
type Vulnerability struct {
	ID               string
	PkgName          string
	PkgPath          string
	InstalledVersion string
	FixedVersion     string
	Severity         string
	Title            string
	Description      string
	References       []string
	PrimaryURL       string
	CweIDs           []string
	CVSS             map[string]CVSS
	PublishedDate    string
	LastModifiedDate string
	Status           types.VulnStatus
	CreatedAt        time.Time
	UpdatedAt        time.Time
}

// NewVulnerability creates a Vulnerability from Trivy's DetectedVulnerability
func NewVulnerability(detected *trivy.DetectedVulnerability) *Vulnerability {
	now := time.Now()

	// CVSS information conversion
	cvss := make(map[string]CVSS)
	for sourceID, vendorCVSS := range detected.CVSS {
		cvss[string(sourceID)] = CVSS{
			V2Vector: vendorCVSS.V2Vector,
			V3Vector: vendorCVSS.V3Vector,
			V2Score:  vendorCVSS.V2Score,
			V3Score:  vendorCVSS.V3Score,
		}
	}

	return &Vulnerability{
		ID:               detected.VulnerabilityID,
		PkgName:          detected.PkgName,
		PkgPath:          detected.PkgPath,
		InstalledVersion: detected.InstalledVersion,
		FixedVersion:     detected.FixedVersion,
		Severity:         detected.Severity,
		Title:            detected.Title,
		Description:      detected.Description,
		References:       detected.References,
		PrimaryURL:       detected.PrimaryURL,
		CweIDs:           detected.CweIDs,
		CVSS:             cvss,
		PublishedDate:    detected.PublishedDate,
		LastModifiedDate: detected.LastModifiedDate,
		Status:           types.VulnStatusActive,
		CreatedAt:        now,
		UpdatedAt:        now,
	}
}
