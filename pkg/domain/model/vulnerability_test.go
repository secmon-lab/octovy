package model_test

import (
	"testing"

	"github.com/m-mizutani/gt"
	"github.com/m-mizutani/octovy/pkg/domain/model"
	"github.com/m-mizutani/octovy/pkg/domain/model/trivy"
	"github.com/m-mizutani/octovy/pkg/domain/types"
)

func TestNewVulnerability(t *testing.T) {
	t.Run("converts Trivy DetectedVulnerability correctly", func(t *testing.T) {
		detected := &trivy.DetectedVulnerability{
			VulnerabilityID:  "CVE-2024-1234",
			PkgName:          "test-package",
			PkgPath:          "/path/to/package",
			InstalledVersion: "1.0.0",
			FixedVersion:     "1.0.1",
			PrimaryURL:       "https://nvd.nist.gov/vuln/detail/CVE-2024-1234",
			Vulnerability: trivy.Vulnerability{
				Severity:    "HIGH",
				Title:       "Test Vulnerability",
				Description: "This is a test vulnerability",
				References:  []string{"https://example.com/vuln1", "https://example.com/vuln2"},
				CweIDs:      []string{"CWE-79", "CWE-89"},
				CVSS: map[trivy.SourceID]trivy.CVSS{
					"nvd": {
						V2Vector: "AV:N/AC:L/Au:N/C:P/I:P/A:P",
						V3Vector: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
						V2Score:  7.5,
						V3Score:  9.8,
					},
				},
				PublishedDate:    "2024-01-01T00:00:00Z",
				LastModifiedDate: "2024-01-02T00:00:00Z",
			},
		}

		vuln := model.NewVulnerability(detected)

		// Verify all fields are correctly mapped
		gt.V(t, vuln.ID).Equal("CVE-2024-1234")
		gt.V(t, vuln.PkgName).Equal("test-package")
		gt.V(t, vuln.PkgPath).Equal("/path/to/package")
		gt.V(t, vuln.InstalledVersion).Equal("1.0.0")
		gt.V(t, vuln.FixedVersion).Equal("1.0.1")
		gt.V(t, vuln.Severity).Equal("HIGH")
		gt.V(t, vuln.Title).Equal("Test Vulnerability")
		gt.V(t, vuln.Description).Equal("This is a test vulnerability")
		gt.V(t, len(vuln.References)).Equal(2)
		gt.V(t, vuln.References[0]).Equal("https://example.com/vuln1")
		gt.V(t, vuln.References[1]).Equal("https://example.com/vuln2")
		gt.V(t, vuln.PrimaryURL).Equal("https://nvd.nist.gov/vuln/detail/CVE-2024-1234")
		gt.V(t, len(vuln.CweIDs)).Equal(2)
		gt.V(t, vuln.CweIDs[0]).Equal("CWE-79")
		gt.V(t, vuln.CweIDs[1]).Equal("CWE-89")
		gt.V(t, vuln.PublishedDate).Equal("2024-01-01T00:00:00Z")
		gt.V(t, vuln.LastModifiedDate).Equal("2024-01-02T00:00:00Z")
	})

	t.Run("preserves CVSS structure with original format", func(t *testing.T) {
		detected := &trivy.DetectedVulnerability{
			VulnerabilityID: "CVE-2024-5678",
			PkgName:         "another-package",
			Vulnerability: trivy.Vulnerability{
				CVSS: map[trivy.SourceID]trivy.CVSS{
					"nvd": {
						V2Vector: "AV:N/AC:M/Au:N/C:P/I:P/A:P",
						V3Vector: "CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H",
						V2Score:  6.8,
						V3Score:  8.1,
					},
					"redhat": {
						V3Vector: "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H",
						V3Score:  7.8,
					},
				},
			},
		}

		vuln := model.NewVulnerability(detected)

		// Verify CVSS map structure is preserved
		gt.V(t, len(vuln.CVSS)).Equal(2)

		nvdCVSS, exists := vuln.CVSS["nvd"]
		gt.True(t, exists)
		gt.V(t, nvdCVSS.V2Vector).Equal("AV:N/AC:M/Au:N/C:P/I:P/A:P")
		gt.V(t, nvdCVSS.V3Vector).Equal("CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H")
		gt.V(t, nvdCVSS.V2Score).Equal(6.8)
		gt.V(t, nvdCVSS.V3Score).Equal(8.1)

		redhatCVSS, exists := vuln.CVSS["redhat"]
		gt.True(t, exists)
		gt.V(t, redhatCVSS.V3Vector).Equal("CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H")
		gt.V(t, redhatCVSS.V3Score).Equal(7.8)
		gt.V(t, redhatCVSS.V2Vector).Equal("") // Not provided
		gt.V(t, redhatCVSS.V2Score).Equal(0.0) // Not provided
	})

	t.Run("sets Status to Active for new detection", func(t *testing.T) {
		detected := &trivy.DetectedVulnerability{
			VulnerabilityID: "CVE-2024-9999",
			PkgName:         "test-pkg",
		}

		vuln := model.NewVulnerability(detected)

		// Verify initial status is Active
		gt.V(t, vuln.Status).Equal(types.VulnStatusActive)
	})

	t.Run("sets CreatedAt and UpdatedAt timestamps", func(t *testing.T) {
		detected := &trivy.DetectedVulnerability{
			VulnerabilityID: "CVE-2024-0001",
			PkgName:         "test-pkg",
		}

		vuln := model.NewVulnerability(detected)

		// Verify timestamps are set (non-zero)
		gt.V(t, vuln.CreatedAt.IsZero()).Equal(false)
		gt.V(t, vuln.UpdatedAt.IsZero()).Equal(false)
		// CreatedAt and UpdatedAt should be equal for new vulnerability
		gt.V(t, vuln.CreatedAt).Equal(vuln.UpdatedAt)
	})

	t.Run("handles empty CVSS map", func(t *testing.T) {
		detected := &trivy.DetectedVulnerability{
			VulnerabilityID: "CVE-2024-1111",
			PkgName:         "minimal-pkg",
		}

		vuln := model.NewVulnerability(detected)

		// Verify CVSS map is initialized but empty
		gt.V(t, vuln.CVSS).NotEqual(nil)
		gt.V(t, len(vuln.CVSS)).Equal(0)
	})
}
